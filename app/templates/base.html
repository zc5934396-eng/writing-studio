<!DOCTYPE html>
<html lang="id" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}OnThesis Pro{% endblock %}</title>
    
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/logo-onthesis.png') }}" type="image/x-icon">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        bg: { main: '#121417', sidebar: '#1F2128', card: '#242731', input: '#2D303E' },
                        accent: { primary: '#6C5DD3', hover: '#5b4dcf', cyan: '#00D1FF' },
                        text: { primary: '#FFFFFF', secondary: '#808191', muted: '#5F616B' }
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    {% block page_styles %}{% endblock %}
    
    <style>
        [x-cloak] { display: none !important; }
        .z-sidebar { z-index: 40; }
        .z-header { z-index: 50; }
        .z-dropdown { z-index: 60; }
        .z-modal { z-index: 100; }
    </style>
</head>

<body x-data="{ sidebarOpen: window.innerWidth >= 1024, profileOpen: false }">

    <div class="flex h-screen overflow-hidden bg-bg-main text-text-primary">
        
        <aside class="fixed inset-y-0 left-0 z-sidebar w-64 bg-bg-sidebar border-r border-white/5 transition-all duration-300 ease-in-out lg:static shrink-0 flex flex-col"
               :class="sidebarOpen ? 'translate-x-0 lg:ml-0' : '-translate-x-full lg:-ml-64'">
            
            <div class="flex items-center justify-center h-16 border-b border-white/5 shrink-0">
                <a href="{{ url_for('main.dashboard') }}" class="flex items-center justify-center w-full hover:opacity-80 transition">
                     <img src="{{ url_for('static', filename='images/logo-onthesis-new.png') }}" alt="Logo" class="h-9 w-auto object-contain">
                </a>
            </div>

            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto custom-scroll">
                <p class="px-4 text-xs font-bold text-text-muted uppercase tracking-wider mb-3">Menu Utama</p>
                
                {% set nav_items = [
                    ('main.dashboard', 'layout-grid', 'Dashboard'),
                    ('main.projects', 'folder-open', 'Proyek'),
                    ('main.citation_management', 'book-open', 'Sitasi'),
                    ('main.paraphrase_ai', 'refresh-cw', 'Parafrase AI'),
                    ('main.chat_ai', 'message-circle', 'Curhat AI')
                ] %}

                {% for endpoint, icon, label in nav_items %}
                <a href="{{ url_for(endpoint) }}" 
                   class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-sm font-medium mb-1
                          {{ 'bg-accent-primary text-white shadow-lg shadow-accent-primary/20' if request.endpoint == endpoint else 'text-text-secondary hover:bg-white/5 hover:text-white' }}">
                    <i data-lucide="{{ icon }}" class="w-4.5 h-4.5"></i>
                    <span>{{ label }}</span>
                </a>
                {% endfor %}

                <p class="px-4 text-xs font-bold text-text-muted uppercase tracking-wider mt-8 mb-3">Alat Canggih</p>
                
                <a href="{{ url_for('assistant.writing_assistant') }}" 
                   class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-sm font-medium mb-1
                          {{ 'bg-accent-primary text-white shadow-lg shadow-accent-primary/20' if 'assistant.' in request.endpoint else 'text-text-secondary hover:bg-white/5 hover:text-white' }}">
                    <i data-lucide="pen-tool" class="w-4.5 h-4.5"></i>
                    <span class="flex-1">Writing Studio</span>
                    <span class="text-[9px] font-bold bg-white/20 text-white px-1.5 py-0.5 rounded">PRO</span>
                </a>

                <a href="{{ url_for('assistant.thesis_defense_page') }}" 
                    class="flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-xl transition-all duration-200 group {{ 'bg-red-500/10 text-red-400 border border-red-500/20' if request.path == '/thesis-defense' else 'text-gray-400 hover:text-white hover:bg-white/5' }}">
                 <div class="p-1.5 rounded-lg {{ 'bg-red-500/20 text-red-400' if request.path == '/thesis-defense' else 'bg-gray-800 text-gray-400 group-hover:bg-gray-700 group-hover:text-white' }} transition-colors">
                    <i data-lucide="shield-alert" class="w-4 h-4"></i>
                </div>
                 <span>Simulasi Sidang</span>
                    <span class="ml-auto text-[10px] font-bold bg-red-600 text-white px-2 py-0.5 rounded-full shadow-lg shadow-red-900/50">BARU</span>
                </a>

                <a href="{{ url_for('analysis.data_analysis') }}" 
                   class="flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-sm font-medium mb-1
                          {{ 'bg-accent-primary text-white shadow-lg shadow-accent-primary/20' if 'analysis.' in request.endpoint else 'text-text-secondary hover:bg-white/5 hover:text-white' }}">
                    <i data-lucide="bar-chart-2" class="w-4.5 h-4.5"></i>
                    <span class="flex-1">Analisis Data</span>
                    <span class="text-[9px] font-bold bg-white/20 text-white px-1.5 py-0.5 rounded">PRO</span>
                </a>
            </nav>

            <div class="p-4 border-t border-white/5 mt-auto">
                <div class="flex items-center gap-3 px-3 py-2 bg-bg-card rounded-xl border border-white/5">
                    <img class="w-8 h-8 rounded-full border border-white/10" 
                         src="{{ current_user.photo_url or 'https://ui-avatars.com/api/?name=' + (current_user.username|urlencode) + '&background=random' }}" 
                         alt="User">
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold text-white truncate">{{ current_user.username }}</p>
                        <p class="text-[10px] text-text-secondary truncate">{{ 'PRO Plan' if current_user.is_pro else 'Free Plan' }}</p>
                    </div>
                </div>
            </div>
        </aside>

        <div x-show="sidebarOpen" @click="sidebarOpen = false" 
             class="fixed inset-0 z-30 bg-black/50 backdrop-blur-sm lg:hidden"
             x-transition.opacity></div>

        <div class="flex-1 flex flex-col h-screen overflow-hidden relative">
            
            <header class="h-16 bg-bg-main/90 backdrop-blur-md border-b border-white/5 flex items-center justify-between px-4 lg:px-8 shrink-0 z-header">
                
                <div class="flex items-center">
                    <button @click="sidebarOpen = !sidebarOpen" 
                            class="p-2 -ml-2 mr-2 text-text-secondary hover:text-white hover:bg-white/5 rounded-lg transition-colors"
                            title="Toggle Sidebar">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>

                <div class="flex items-center gap-4 ml-auto">
                    <button class="p-2 text-text-secondary hover:text-white hover:bg-white/5 rounded-lg transition relative">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-bg-main"></span>
                    </button>
                    
                    <div class="relative">
                        <button @click="profileOpen = !profileOpen" @click.outside="profileOpen = false" 
                                class="flex items-center gap-2 focus:outline-none hover:bg-white/5 p-1.5 rounded-lg transition">
                            <span class="text-xs font-bold text-white text-right hidden md:block">
                                {{ current_user.username }}<br>
                                <span class="text-text-muted font-normal">Pengaturan</span>
                            </span>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-text-secondary transition-transform" :class="profileOpen ? 'rotate-180' : ''"></i>
                        </button>
                        
                        <div x-show="profileOpen" x-cloak
                             class="absolute right-0 mt-2 w-48 bg-bg-card border border-white/10 rounded-xl shadow-2xl py-1 z-dropdown"
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 translate-y-2"
                             x-transition:enter-end="opacity-100 translate-y-0"
                             x-transition:leave="transition ease-in duration-150"
                             x-transition:leave-start="opacity-100 translate-y-0"
                             x-transition:leave-end="opacity-0 translate-y-2">
                            
                            <div class="px-4 py-2 border-b border-white/5 md:hidden">
                                <p class="text-xs font-bold text-white">{{ current_user.username }}</p>
                                <p class="text-[10px] text-text-secondary">{{ current_user.email }}</p>
                            </div>

                            <a href="{{ url_for('main.user_profile') }}" class="flex items-center gap-2 px-4 py-2.5 text-xs font-medium text-text-secondary hover:bg-white/5 hover:text-white transition-colors">
                                <i data-lucide="user" class="w-3.5 h-3.5"></i> Profil Saya
                            </a>
                            <a href="{{ url_for('main.upgrade_page') }}" class="flex items-center gap-2 px-4 py-2.5 text-xs font-medium text-text-secondary hover:bg-white/5 hover:text-white transition-colors">
                                <i data-lucide="zap" class="w-3.5 h-3.5 text-yellow-400"></i> Upgrade Plan
                            </a>
                            <div class="border-t border-white/5 my-1"></div>
                            <a href="{{ url_for('auth.logout') }}" class="flex items-center gap-2 px-4 py-2.5 text-xs font-bold text-red-400 hover:bg-red-500/10 transition-colors cursor-pointer">
                                <i data-lucide="log-out" class="w-3.5 h-3.5"></i> Keluar
                            </a>
                        </div>
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto scroll-smooth relative bg-[#121417] z-0">
                
                {% block content_wrapper %}
                <div class="px-4 md:px-8 py-6">
                    
                    {% with messages = get_flashed_messages(with_categories=true) %}
                      {% if messages %}
                        <div class="mb-6 space-y-2 animate-fade-in-up">
                        {% for category, message in messages %}
                          <div class="p-3 rounded-xl text-xs font-medium flex items-center gap-2 shadow-lg backdrop-blur-sm
                                      {{ 'bg-green-500/10 text-green-400 border border-green-500/20' if category == 'success' else 'bg-red-500/10 text-red-400 border border-red-500/20' }}">
                            <i data-lucide="{{ 'check-circle' if category == 'success' else 'alert-circle' }}" class="w-4 h-4 flex-shrink-0"></i>
                            {{ message }}
                          </div>
                        {% endfor %}
                        </div>
                      {% endif %}
                    {% endwith %}

                    {% block content %}{% endblock %}
                </div>
                {% endblock %}

            </main>
        </div>
    </div>
    
    <div id="feedback-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 hidden feedback-modal bg-black/80 backdrop-blur-sm">
        <div class="w-full max-w-lg bg-bg-card border border-white/10 rounded-2xl shadow-2xl p-8 transform transition-all opacity-0 -translate-y-4" id="feedback-modal-card">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Kirim Masukan</h3>
                <button id="close-feedback-modal-btn" class="text-text-secondary hover:text-white"><i data-lucide="x"></i></button>
            </div>
             <div id="feedback-form-container">
                <form id="feedback-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">Kategori</label>
                            <select name="category" class="feedback-form-input">
                                <option>Saran Fitur</option><option>Laporan Bug</option><option>Lainnya</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-2">Pesan</label>
                            <textarea name="message" rows="4" class="feedback-form-input" required></textarea>
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" id="submit-feedback-btn" class="btn-primary">Kirim</button>
                        </div>
                    </div>
                </form>
            </div>
             <div id="feedback-success-message" class="hidden text-center py-8">
                <p class="text-2xl mb-4">âœ…</p><h4 class="text-xl font-bold text-white">Terima Kasih!</h4>
            </div>
        </div>
    </div>

    {% block modals %}{% endblock %}

    <script src="{{ url_for('static', filename='js/script.js') }}" type="module"></script>
    {% block page_scripts %}{% endblock %}
    
    <script>
        document.addEventListener('mousemove', e => {
            document.documentElement.style.setProperty('--mouse-x', e.clientX + 'px');
            document.documentElement.style.setProperty('--mouse-y', e.clientY + 'px');
        });
        lucide.createIcons();
    </script>
</body>
</html>