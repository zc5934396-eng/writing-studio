{% extends "layout.html" %}

{% block title %}Generator Kajian Teori - Alur Interaktif{% endblock %}

{% block page_styles %}
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown/dist/showdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>


<style>
    /* Gaya konsisten dengan halaman lain */
    .io-panel {
        background-color: var(--bg-panel);
        border: 1px solid var(--border-panel);
        border-radius: 1rem;
        padding: 2rem;
        transition: all 0.3s ease-in-out;
    }
    .io-textarea, .control-input, .control-select {
        width: 100%;
        background-color: var(--bg-canvas);
        border: 1px solid var(--border-panel);
        color: var(--text-primary);
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        transition: all 0.2s ease;
    }
    .io-textarea:focus, .control-input:focus, .control-select:focus {
        outline: none;
        border-color: var(--accent-cyan);
        box-shadow: 0 0 0 3px var(--accent-cyan-glow);
    }
    .control-group label {
        display: block;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.75rem;
    }
     .control-group p {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: -0.5rem;
        margin-bottom: 0.75rem;
    }
    
    /* Gaya untuk panel interaktif */
    #interactive-panel .subchapter-item {
        padding: 1.5rem;
        border: 1px solid var(--border-panel);
        border-radius: 0.75rem;
        background-color: var(--bg-canvas);
        transition: all 0.2s ease;
    }
    #interactive-panel .subchapter-content {
        display: none;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px dashed var(--border-panel);
    }
    .prose p, .prose li { color: var(--text-secondary); }
    .prose strong, .prose h1, .prose h2, .prose h3, .prose code { color: var(--text-primary); }

    /* Gaya untuk Poin Pembahasan */
    .discussion-points {
        margin-top: 0.75rem;
        padding-left: 1rem;
        border-left: 2px solid var(--border-panel);
    }
    .discussion-points p {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }
    .discussion-points ul {
        list-style-type: disc;
        list-style-position: inside;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    .discussion-points ul li {
        padding-bottom: 0.25rem;
    }

    /* Gaya Loading Overlay */
    #loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(13, 17, 23, 0.8);
        backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        z-index: 100; display: none; justify-content: center; align-items: center;
        flex-direction: column; color: var(--text-primary); transition: opacity 0.3s ease;
    }
    .loading-spinner {
        width: 48px; height: 48px;
        border: 4px solid var(--border-panel);
        border-top-color: var(--accent-cyan);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}

{% block content %}
<div class="h-full w-full p-4 sm:p-6 lg:p-8 overflow-y-auto">
    <header class="w-full max-w-4xl mx-auto mb-8">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('assistant.writing_assistant') }}" class="btn-secondary !p-2" title="Kembali ke Menu"><i data-lucide="arrow-left"></i></a>
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-primary">Generator Kajian Teori (Alur Interaktif)</h1>
                <p class="text-md text-secondary mt-1">Buat kerangka, lalu generate konten per sub-bab untuk kontrol penuh.</p>
            </div>
        </div>
    </header>

    <div class="w-full flex flex-col items-center gap-8">
        <div id="input-panel" class="io-panel w-full max-w-4xl">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <div class="control-group md:col-span-2">
                    <label for="project-select">1. Pilih Proyek Riset (Opsional)</label>
                    <p>Pilih proyek untuk menggunakan referensi yang sudah Anda simpan di "Manajemen Sitasi".</p>
                    <select id="project-select" class="control-select">
                        <option value="">Jangan gunakan proyek (cari referensi baru)</option>
                    </select>
                </div>
                <div class="control-group md:col-span-2">
                    <label for="input-title">2. Judul Penelitian (Wajib)</label>
                    <textarea id="input-title" class="io-textarea" placeholder="Contoh: Pengaruh Media Sosial terhadap Produktivitas Mahasiswa"></textarea>
                </div>
                <div class="control-group md:col-span-2">
                    <label for="input-keywords">3. Kata Kunci Tambahan (Opsional)</label>
                    <textarea id="input-keywords" class="io-textarea !min-h-[60px]" placeholder="Contoh: media sosial, produktivitas, mahasiswa"></textarea>
                </div>
                <div class="control-group">
                    <label for="length-preference">4. Tingkat Detail Tulisan</label>
                    <select id="length-preference" class="control-select">
                        <option value="Ringkas">Ringkas</option>
                        <option value="Normal" selected>Normal</option>
                        <option value="Detail">Detail</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="citation-style">5. Gaya Sitasi</label>
                    <select id="citation-style" class="control-select">
                        <option value="APA 7" selected>APA 7</option>
                        <option value="IEEE">IEEE</option>
                    </select>
                </div>
            </div>
            <div class="text-center mt-8 pt-8 border-t border-border-panel">
                <button id="generate-outline-btn" class="btn-primary">
                    <i data-lucide="layout-list" class="w-5 h-5 mr-2"></i>
                    Buat Kerangka & Kumpulkan Referensi
                </button>
            </div>
        </div>

        <div id="interactive-panel" class="io-panel w-full max-w-5xl hidden flex-col gap-4">
            <h2 class="text-xl font-bold text-primary pb-4 border-b border-border-panel">Generate Konten per Sub-bab</h2>
            <div id="subchapter-list" class="space-y-4">
                </div>
            <div class="text-center mt-4 pt-4 border-t border-border-panel">
                <button id="compile-btn" class="btn-primary hidden">
                    <i data-lucide="file-check-2" class="w-5 h-5 mr-2"></i>
                    Gabungkan & Selesaikan (Ekspor)
                </button>
            </div>
        </div>

        <div id="final-output-panel" class="io-panel w-full max-w-5xl hidden flex-col gap-4">
            <div class="flex flex-wrap justify-between items-center pb-4 border-b border-border-panel gap-4">
                <h2 class="text-xl font-bold text-primary">Hasil Final Bab 2</h2>
                <div class="flex items-center gap-2">
                    <button id="export-word-btn" class="btn-secondary" title="Ekspor ke Word"><i data-lucide="file-text" class="w-4 h-4 mr-2"></i>Ekspor Word</button>
                    <button id="export-pdf-btn" class="btn-secondary" title="Ekspor ke PDF"><i data-lucide="file-type-2" class="w-4 h-4 mr-2"></i>Ekspor PDF</button>
                </div>
            </div>
            <div id="final-output-content" class="io-output prose max-w-none prose-invert"></div>
        </div>
    </div>
</div>

<div id="notification-container" class="fixed top-5 right-5 z-[1001] w-full max-w-xs"></div>
<div id="loading-overlay"><div class="loading-spinner"></div><p id="loading-status-text" class="mt-4 text-secondary">Memproses...</p></div>
{% endblock %}

{% block page_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- State Global ---
    let researchData = {
        outline: [],
        references: [],
        generatedContent: {}
    };

    // --- Referensi Elemen DOM ---
    const projectSelect = document.getElementById('project-select'); // <-- BARU
    const generateOutlineBtn = document.getElementById('generate-outline-btn');
    const interactivePanel = document.getElementById('interactive-panel');
    const subchapterList = document.getElementById('subchapter-list');
    const compileBtn = document.getElementById('compile-btn');
    const finalOutputPanel = document.getElementById('final-output-panel');
    const finalOutputContent = document.getElementById('final-output-content');
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingStatusText = document.getElementById('loading-status-text');

    // --- Fungsi Pembantu ---
    const renderIcons = () => window.lucide && window.lucide.createIcons();
    const showLoading = (text = "Memproses...") => {
        loadingStatusText.textContent = text;
        loadingOverlay.style.display = 'flex';
    };
    const hideLoading = () => { loadingOverlay.style.display = 'none'; };
    const showNotification = (message, type = 'success') => {
        const container = document.getElementById('notification-container');
        if (!container) return; // Penjagaan jika notifikasi tidak ada di layout
        const notif = document.createElement('div');
        const bgColor = type === 'error' ? 'bg-red-500/90' : 'bg-green-500/90';
        const icon = type === 'error' ? 'shield-x' : 'check-circle';
        notif.className = `flex items-center gap-3 px-4 py-3 text-white ${bgColor} rounded-lg shadow-lg mb-2 animate-fade-in-up backdrop-blur-sm`;
        notif.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i><span>${message}</span>`;
        container.appendChild(notif);
        renderIcons();
        setTimeout(() => notif.remove(), 4000);
    };

    // --- PERUBAHAN: Ambil Daftar Proyek Saat Halaman Dimuat ---
    const fetchUserProjects = async () => {
        try {
            const response = await fetch('/api/get-user-projects'); // Panggil API baru
            if (!response.ok) throw new Error('Gagal mengambil daftar proyek.');
            const projects = await response.json();
            
            if (projects.length > 0) {
                projects.forEach(project => {
                    projectSelect.innerHTML += `<option value="${project.id}">${project.title}</option>`;
                });
            }
        } catch (error) {
            console.warn(error.message);
            projectSelect.disabled = true;
            projectSelect.querySelector('option').textContent = "Gagal memuat proyek";
        }
    };
    fetchUserProjects();
    // --- AKHIR PERUBAHAN ---

    // --- TAHAP 1: Generate Kerangka & Cari Referensi ---
    generateOutlineBtn.addEventListener('click', async () => {
        const title = document.getElementById('input-title').value.trim();
        if (!title) {
            showNotification('Judul Penelitian tidak boleh kosong.', 'error');
            return;
        }

        // --- PERUBAHAN: Tambahkan projectId ke payload ---
        const selectedProjectId = projectSelect.value;
        const payload = {
            title: title,
            keywords: document.getElementById('input-keywords').value.trim(),
            projectId: selectedProjectId || null // Kirim null jika tidak dipilih
        };

        showLoading("Membuat kerangka & mengumpulkan referensi...");
        try {
            const response = await fetch('/api/generate-outline-and-refs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload) // Kirim payload baru
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            // --- AKHIR PERUBAHAN ---

            researchData.outline = result.outline;
            researchData.references = result.references;
            displaySubchapters();
            interactivePanel.classList.remove('hidden');
            interactivePanel.classList.add('flex');
            document.getElementById('input-panel').classList.add('hidden');
            showNotification(`Kerangka & ${result.references.length} referensi dikumpulkan.`, 'success');
        } catch (error) {
            showNotification(error.message, 'error');
        } finally {
            hideLoading();
        }
    });

    // --- Menampilkan Daftar Sub-bab (Tidak Berubah) ---
    const displaySubchapters = () => {
        subchapterList.innerHTML = '';
        researchData.outline.forEach((item, index) => {
            const pointsHtml = (item.poin_pembahasan || [])
                .map(point => `<li>${point}</li>`).join('');

            const div = document.createElement('div');
            div.className = 'subchapter-item';
            div.innerHTML = `
                <div class="flex justify-between items-start gap-4">
                    <div class="flex-grow">
                        <h3 class="text-lg font-bold text-primary">${item.sub_bab}</h3>
                        <div class="discussion-points">
                            <p>Pokok Pembahasan:</p>
                            <ul>${pointsHtml}</ul>
                        </div>
                    </div>
                    <button class="btn-secondary generate-sub-btn flex-shrink-0" data-index="${index}">
                        <i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>Generate Isi
                    </button>
                </div>
                <div class="subchapter-content prose max-w-none prose-invert"></div>
            `;
            subchapterList.appendChild(div);
        });
        renderIcons();
    };

    // --- TAHAP 2: Generate Konten per Sub-bab (Tidak Berubah) ---
    subchapterList.addEventListener('click', async (e) => {
        const button = e.target.closest('.generate-sub-btn');
        if (!button) return;

        button.disabled = true;
        button.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Menulis...`;
        renderIcons();

        const index = parseInt(button.dataset.index);
        const subchapterItem = researchData.outline[index];
        const contentDiv = button.closest('.subchapter-item').querySelector('.subchapter-content');

        try {
            const response = await fetch('/api/generate-subchapter-content', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    subchapter: subchapterItem,
                    references: researchData.references,
                    title: document.getElementById('input-title').value.trim(),
                    length_preference: document.getElementById('length-preference').value,
                    citation_style: document.getElementById('citation-style').value
                })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error);
            
            const converter = new showdown.Converter({ tables: true, openLinksInNewWindow: true, simpleLineBreaks: true });
            contentDiv.innerHTML = converter.makeHtml(result.generated_text);
            contentDiv.style.display = 'block';
            researchData.generatedContent[subchapterItem.sub_bab] = result.generated_text;
            
            button.innerHTML = `<i data-lucide="check" class="w-4 h-4 mr-2"></i>Selesai`;
            renderIcons();
            compileBtn.classList.remove('hidden');

        } catch (error) {
            showNotification(error.message, 'error');
            button.disabled = false;
            button.innerHTML = `<i data-lucide="sparkles" class="w-4 h-4 mr-2"></i>Generate Ulang`;
            renderIcons();
        }
    });

    // --- TAHAP 3: Kompilasi Dokumen Final (Tidak Berubah) ---
    compileBtn.addEventListener('click', () => {
        let fullText = `## BAB 2 KAJIAN TEORI\n\n`;
        let bibliography = new Set();

        researchData.outline.forEach(item => {
            const content = researchData.generatedContent[item.sub_bab];
            if (content) {
                fullText += `### ${item.sub_bab}\n\n${content.trim()}\n\n`;
            }
        });

        if (researchData.references.length > 0) {
            fullText += `### Daftar Pustaka\n\n`;
            researchData.references.forEach(ref => {
                const author = ref.author || 'N/A';
                const year = ref.year || 'N/A';
                const title = ref.title || 'N/A';
                const journal = ref.journal || 'N/A';
                const doi = ref.doi ? `https://doi.org/${ref.doi}` : (ref.pdfUrl || '');
                const citation = `${author} (${year}). *${title}*. ${journal}. ${doi}`;
                bibliography.add(citation);
            });
            fullText += [...bibliography].sort().join('\n\n');
        }

        const converter = new showdown.Converter({ tables: true, openLinksInNewWindow: true, simpleLineBreaks: true });
        finalOutputContent.innerHTML = converter.makeHtml(fullText);
        finalOutputPanel.classList.remove('hidden');
        finalOutputPanel.classList.add('flex');
        finalOutputPanel.scrollIntoView({ behavior: 'smooth' });
        showNotification('Dokumen berhasil digabungkan!', 'success');
    });

    // --- Logika Ekspor Profesional (Tidak Berubah) ---
    const loadImageAsBase64 = (url) => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL('image/png'));
            };
            img.onerror = (err) => {
                console.error("Gagal memuat gambar dari URL:", url);
                reject(err);
            };
            img.src = url;
        });
    };
    
    const handleExport = async (format) => {
        const contentHtml = finalOutputContent.innerHTML;
        const title = document.getElementById('input-title').value.trim() || "Kajian Teori";
        if (!contentHtml.trim()) {
            showNotification('Tidak ada konten untuk diekspor.', 'error');
            return;
        }

        const btn = format === 'pdf' ? document.getElementById('export-pdf-btn') : document.getElementById('export-word-btn');
        btn.disabled = true;
        btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-4 h-4 mr-2"></i>Mengekspor...`;
        renderIcons();

        try {
            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const margin = 15;
                const maxWidth = doc.internal.pageSize.width - margin * 2;
                let y = 15; 

                const checkPageBreak = (currentY, elementHeight) => {
                    if (currentY + elementHeight > doc.internal.pageSize.height - margin) {
                        doc.addPage();
                        return margin; 
                    }
                    return currentY; 
                };

                try {
                    const logoUrl = "{{ url_for('static', filename='images/onthesis-logo-black.png') }}";
                    const logoData = await loadImageAsBase64(logoUrl);
                    doc.addImage(logoData, 'PNG', doc.internal.pageSize.width - margin - 30, 10, 30, 8);
                } catch (logoError) { console.warn("Logo tidak dapat dimuat."); }

                doc.setFontSize(16).setFont('helvetica', 'bold').setTextColor('#000000');
                doc.text("Draf Bab 2: Kajian Teori", margin, y);
                y += 8;
                doc.setFontSize(11).setFont('helvetica', 'italic').setTextColor('#444444');
                const splitTitle = doc.splitTextToSize(`Topik: ${title}`, maxWidth);
                doc.text(splitTitle, margin, y);
                y += (splitTitle.length * 5) + 5;
                doc.setLineWidth(0.5).line(margin, y, doc.internal.pageSize.width - margin, y);
                y += 8;
                doc.setTextColor('#000000');

                const sourceElement = finalOutputContent; 
                const children = sourceElement.childNodes;

                for (const node of children) {
                    if (node.nodeType !== 1 || !node.textContent.trim()) continue;
                    const tagName = node.tagName.toUpperCase();
                    
                    if (tagName === 'H2') {
                        doc.setFontSize(14).setFont('helvetica', 'bold');
                        const lines = doc.splitTextToSize(node.textContent, maxWidth);
                        const elementHeight = lines.length * 6;
                        y = checkPageBreak(y, elementHeight);
                        doc.text(lines, margin, y);
                        y += elementHeight + 4;
                    } 
                    else if (tagName === 'H3') {
                        doc.setFontSize(12).setFont('helvetica', 'bold');
                        const lines = doc.splitTextToSize(node.textContent, maxWidth);
                        const elementHeight = lines.length * 5;
                        y = checkPageBreak(y, elementHeight);
                        doc.text(lines, margin, y);
                        y += elementHeight + 3;
                    }
                    else if (tagName === 'P') {
                        doc.setFontSize(11).setFont('helvetica', 'normal');
                        const cleanText = node.textContent.replace(/\u00a0/g, ' ').replace(/\s+/g, ' ');
                        const lines = doc.splitTextToSize(cleanText, maxWidth);
                        const elementHeight = lines.length * 5;
                        y = checkPageBreak(y, elementHeight);
                        doc.text(lines, margin, y, { align: 'justify', maxWidth: maxWidth });
                        y += elementHeight + 4; 
                    }
                    else if (tagName === 'UL' || tagName === 'OL') {
                        doc.setFontSize(10).setFont('helvetica', 'normal');
                        const listItems = node.querySelectorAll('li');
                        if (listItems.length === 0) continue;
                        
                        for (const [index, item] of Array.from(listItems).entries()) {
                            const itemPrefix = (tagName === 'OL') ? `${index + 1}. ` : 'â€¢ ';
                            const itemMaxWidth = maxWidth - 7; 
                            const lines = doc.splitTextToSize(item.textContent, itemMaxWidth);
                            const elementHeight = lines.length * 4.5;
                            y = checkPageBreak(y, elementHeight);
                            doc.text(itemPrefix, margin, y);
                            doc.text(lines, margin + 7, y);
                            y += elementHeight + 2; 
                        }
                        y += 4;
                    }
                }
                doc.save(`Bab_2_${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);

            } else if (format === 'doc') {
                let content = `<style>body { font-family: 'Times New Roman', Times, serif; font-size: 12pt; } h1, h2, h3, h4 { font-family: 'Times New Roman', Times, serif; } p { margin-bottom: 12pt; line-height: 1.5; } ul { margin-left: 40px; }</style>${finalOutputContent.innerHTML}`;
                var converted = htmlDocx.asBlob(content, {orientation: 'portrait', margins: {top: 720}});
                saveAs(converted, `Bab_2_${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.docx`);
            }
            showNotification(`File ${format.toUpperCase()} berhasil diunduh!`, 'success');
        } catch (error) {
            console.error("Gagal mengekspor:", error);
            showNotification(`Terjadi kesalahan saat mengekspor ke ${format.toUpperCase()}.`, 'error');
        } finally {
            btn.disabled = false;
            const icon = format === 'pdf' ? 'file-type-2' : 'file-text';
            btn.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 mr-2"></i>Ekspor ${format === 'pdf' ? 'PDF' : 'Word'}`;
            renderIcons();
        }
    };

    document.getElementById('export-pdf-btn').addEventListener('click', () => handleExport('pdf'));
    document.getElementById('export-word-btn').addEventListener('click', () => handleExport('doc'));

    renderIcons();
});
</script>
{% endblock %}