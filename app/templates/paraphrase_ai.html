{% extends "base.html" %}

{% block title %}Paraphrase Studio - OnThesis{% endblock %}

{% block page_styles %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
    .studio-container { height: calc(100vh - 6rem); }

    /* FOCUS MODE UI */
    /* Sidebar dibuat lebih 'muted' (tenggelam) */
    .sidebar-panel {
        background: rgba(15, 17, 21, 0.8); 
        border-right: 1px solid rgba(255,255,255,0.03);
    }

    /* Area Kerja dibuat lebih 'pop' (menonjol) */
    .workspace-area {
        background: radial-gradient(circle at center, #13151a 0%, #0F1115 100%);
    }

    /* Input/Output Card yang Dominan */
    .focus-card {
        background: #16181D;
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 20px;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        display: flex; flex-direction: column;
    }
    
    /* Efek Glow saat fokus */
    .focus-card:focus-within, .focus-card.has-result {
        border-color: rgba(108, 93, 211, 0.5);
        box-shadow: 0 10px 40px rgba(108, 93, 211, 0.15);
        transform: translateY(-2px);
        background: #1A1D24;
    }

    .para-textarea {
        background: transparent; border: none; color: #E2E8F0; 
        padding: 1.5rem; font-size: 1.05rem; width: 100%; height: 100%;
        outline: none; resize: none; line-height: 1.7; font-family: 'Plus Jakarta Sans', sans-serif;
    }
    .para-textarea::placeholder { color: #475569; font-weight: 400; }

    /* Style Cards Kecil */
    .style-btn {
        padding: 0.75rem; border-radius: 12px; 
        background: rgba(255,255,255,0.03); border: 1px solid transparent;
        color: #94A3B8; font-size: 0.75rem; font-weight: 600;
        cursor: pointer; transition: all 0.2s;
        display: flex; flex-direction: column; align-items: center; gap: 4px;
    }
    .style-btn:hover { background: rgba(255,255,255,0.08); color: white; }
    .style-btn.active { 
        background: rgba(108, 93, 211, 0.2); border-color: #6C5DD3; color: #fff;
        box-shadow: 0 0 15px rgba(108, 93, 211, 0.2);
    }

    /* Button Magic */
    .btn-generate {
        background: linear-gradient(90deg, #6C5DD3, #4F46E5);
        color: white; font-weight: 700; letter-spacing: 0.5px;
        box-shadow: 0 10px 30px -10px rgba(108, 93, 211, 0.6);
    }
    .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 15px 35px -10px rgba(108, 93, 211, 0.8); }
    .btn-generate:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
</style>
{% endblock %}

{% block content %}
<div x-data="paraphraseApp()" 
     class="studio-container flex flex-col lg:flex-row overflow-hidden"
     data-user-pro="{{ 'true' if current_user.is_pro else 'false' }}">

    <aside class="w-full lg:w-72 flex flex-col sidebar-panel shrink-0 h-full overflow-y-auto custom-scroll z-20">
        <div class="p-6 flex flex-col h-full">
            
            <div class="mb-6">
                <h2 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-accent-primary"></i> Paraphrase
                </h2>
                <p class="text-[10px] text-text-muted">Writing Studio V2</p>
            </div>

            <div class="mb-6" x-data="{ open: false }" @click.outside="open = false">
                <label class="text-[10px] font-bold text-text-muted uppercase tracking-wider mb-2 block">AI Brain</label>
                <button @click="open = !open" class="w-full flex items-center justify-between px-3 py-2.5 rounded-xl bg-white/5 border border-white/5 hover:border-white/10 transition text-left">
                    <div class="flex items-center gap-2.5">
                        <div class="w-2 h-2 rounded-full shadow-[0_0_8px_currentColor]" :class="getModelColor(selectedModel)"></div>
                        <span class="text-xs font-bold text-white" x-text="getModelName(selectedModel)"></span>
                    </div>
                    <i data-lucide="chevron-down" class="w-3.5 h-3.5 text-text-muted"></i>
                </button>
                
                <div x-show="open" x-transition class="absolute left-6 w-60 mt-2 bg-[#1A1D24] border border-white/10 rounded-xl shadow-2xl py-1 z-50 overflow-hidden">
                    <div @click="selectedModel = 'fast'; open = false" class="px-4 py-3 hover:bg-white/5 cursor-pointer flex items-center gap-3">
                        <img src="{{ url_for('static', filename='images/logo-llama.png') }}" class="w-5 h-5 rounded">
                        <div><p class="text-xs font-bold text-white">Llama 3.3</p><p class="text-[9px] text-text-muted">Gratis & Cepat</p></div>
                    </div>
                    <div @click="isPro ? (selectedModel = 'gemini', open = false) : alert('Upgrade PRO untuk Gemini!')" class="px-4 py-3 hover:bg-white/5 cursor-pointer flex items-center gap-3 opacity-90">
                         <img src="{{ url_for('static', filename='images/logo-gemini.png') }}" class="w-5 h-5 rounded">
                        <div class="flex-1"><p class="text-xs font-bold text-white">Gemini 2.0</p><p class="text-[9px] text-text-muted">Konteks Luas</p></div>
                        <i x-show="!isPro" data-lucide="lock" class="w-3 h-3 text-text-muted"></i>
                    </div>
                    <div @click="isPro ? (selectedModel = 'gpt5', open = false) : alert('Upgrade PRO untuk GPT!')" class="px-4 py-3 hover:bg-white/5 cursor-pointer flex items-center gap-3 opacity-90">
                         <img src="{{ url_for('static', filename='images/logo-chatgpt.png') }}" class="w-5 h-5 rounded">
                        <div class="flex-1"><p class="text-xs font-bold text-white">GPT-5.1</p><p class="text-[9px] text-text-muted">Logika Tinggi</p></div>
                        <i x-show="!isPro" data-lucide="lock" class="w-3 h-3 text-text-muted"></i>
                    </div>
                    <div @click="isPro ? (selectedModel = 'claude', open = false) : alert('Upgrade PRO untuk Claude!')" class="px-4 py-3 hover:bg-white/5 cursor-pointer flex items-center gap-3 opacity-90">
                         <img src="{{ url_for('static', filename='images/logo-claude.png') }}" class="w-5 h-5 rounded">
                        <div class="flex-1"><p class="text-xs font-bold text-white">Claude 3.5</p><p class="text-[9px] text-text-muted">Bahasa Natural</p></div>
                        <i x-show="!isPro" data-lucide="lock" class="w-3 h-3 text-text-muted"></i>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label class="text-[10px] font-bold text-text-muted uppercase tracking-wider mb-2 block">Gaya Bahasa</label>
                <div class="grid grid-cols-2 gap-2">
                    <button @click="selectedStyle = 'academic'" class="style-btn" :class="selectedStyle === 'academic' ? 'active' : ''">
                        <i data-lucide="graduation-cap" class="w-4 h-4"></i> Akademis
                    </button>
                    <button @click="selectedStyle = 'formal'" class="style-btn" :class="selectedStyle === 'formal' ? 'active' : ''">
                        <i data-lucide="briefcase" class="w-4 h-4"></i> Formal
                    </button>
                    <button @click="selectedStyle = 'simple'" class="style-btn" :class="selectedStyle === 'simple' ? 'active' : ''">
                        <i data-lucide="coffee" class="w-4 h-4"></i> Simpel
                    </button>
                    <button @click="selectedStyle = 'creative'" class="style-btn" :class="selectedStyle === 'creative' ? 'active' : ''">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> Kreatif
                    </button>
                </div>
            </div>

            <div class="mb-6 flex-1">
                <label class="text-[10px] font-bold text-text-muted uppercase tracking-wider mb-2 block">Instruksi Khusus</label>
                <textarea x-model="customInstruction" class="w-full bg-white/5 border border-white/5 rounded-xl p-3 text-xs text-white focus:border-accent-primary outline-none resize-none h-24 placeholder-text-muted" placeholder="Contoh: Pertahankan istilah teknis, kurangi kalimat pasif..."></textarea>
            </div>

            <button @click="processParaphrase()" :disabled="isLoading || !inputText" class="btn-generate w-full py-3.5 rounded-xl text-sm flex items-center justify-center gap-2 transition-all">
                <span x-show="!isLoading">Mulai Proses</span>
                <span x-show="isLoading" class="flex items-center gap-2"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> AI Berpikir...</span>
            </button>
            
            <div class="mt-4 text-center">
                 <p class="text-[10px] text-text-muted">Kuota Harian: <span class="font-bold text-white" x-text="isPro ? 'UNLIMITED' : '5x'"></span></p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col workspace-area relative z-10">
        
        <div class="h-14 border-b border-white/5 flex items-center justify-between px-6 shrink-0">
            <div class="text-xs font-bold text-text-secondary flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-accent-primary"></span> Workspace
            </div>
            <div class="flex gap-2" x-show="outputText">
                <button @click="copyResult()" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-xs font-bold text-white transition flex items-center gap-2"><i data-lucide="copy" class="w-3.5 h-3.5"></i> Salin</button>
                <button @click="exportDoc()" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-xs font-bold text-blue-400 transition flex items-center gap-2"><i data-lucide="file-text" class="w-3.5 h-3.5"></i> Word</button>
                <button @click="exportPDF()" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-xs font-bold text-red-400 transition flex items-center gap-2"><i data-lucide="file-down" class="w-3.5 h-3.5"></i> PDF</button>
            </div>
        </div>

        <div class="flex-1 flex flex-col md:flex-row p-6 gap-6 overflow-hidden">
            
            <div class="flex-1 flex flex-col min-h-0">
                <div class="flex justify-between mb-2 px-2">
                    <label class="text-xs font-bold text-text-secondary uppercase tracking-wide">Teks Asli</label>
                    <span class="text-[10px] text-text-muted font-mono" x-text="inputText.length + ' chars'"></span>
                </div>
                <div class="focus-card flex-1 relative">
                    <textarea x-model="inputText" class="para-textarea custom-scroll" placeholder="Tempel teks yang ingin diparafrase di sini..."></textarea>
                    
                    <button x-show="inputText" @click="inputText = ''" class="absolute bottom-4 right-4 p-2 bg-bg-panel rounded-lg text-text-muted hover:text-red-400 transition shadow-lg border border-white/5">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div class="flex-1 flex flex-col min-h-0">
                <div class="flex justify-between mb-2 px-2">
                    <label class="text-xs font-bold text-accent-cyan uppercase tracking-wide flex items-center gap-2">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> Hasil AI
                    </label>
                </div>
                <div class="focus-card flex-1 relative" :class="outputText ? 'has-result' : ''">
                    <div x-show="!outputText && !isLoading" class="absolute inset-0 flex flex-col items-center justify-center text-text-muted opacity-20 select-none">
                        <i data-lucide="pen-tool" class="w-16 h-16 mb-4"></i>
                        <p class="text-sm font-bold">Hasil akan muncul di sini</p>
                    </div>

                    <div x-show="isLoading" class="absolute inset-0 flex flex-col items-center justify-center bg-bg-panel/90 z-10 backdrop-blur-sm rounded-2xl">
                        <div class="w-12 h-12 border-2 border-accent-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                        <p class="text-xs font-bold text-white animate-pulse">Sedang Menulis Ulang...</p>
                    </div>

                    <div x-show="outputText" class="absolute inset-0 p-6 overflow-y-auto custom-scroll">
                        <div id="output-content" class="prose prose-invert prose-sm max-w-none leading-relaxed font-serif text-gray-200" x-html="renderMarkdown(outputText)"></div>
                    </div>
                </div>
            </div>

        </div>
    </main>
</div>

<script>
    function paraphraseApp() {
        return {
            isPro: false,
            selectedModel: 'fast', // default Llama
            selectedStyle: 'academic',
            customInstruction: '',
            inputText: '',
            outputText: '',
            isLoading: false,
            converter: new showdown.Converter({ simpleLineBreaks: true }),

            init() {
                this.isPro = this.$el.dataset.userPro === 'true';
                this.$nextTick(() => lucide.createIcons());
            },

            getModelName(id) {
                const map = { 'fast': 'Llama 3.3', 'gpt5': 'GPT-5.1', 'claude': 'Claude 3.5', 'gemini': 'Gemini 2.0' };
                return map[id] || 'AI Model';
            },
            getModelColor(id) {
                const map = { 'fast': 'bg-green-500', 'gpt5': 'bg-purple-500', 'claude': 'bg-orange-500', 'gemini': 'bg-blue-500' };
                return map[id] || 'bg-gray-500';
            },

            async processParaphrase() {
                if (!this.inputText.trim()) return alert("Masukkan teks dulu!");
                
                this.isLoading = true;
                this.outputText = ''; 
                
                let textToSend = this.inputText;
                if (this.customInstruction) {
                    textToSend = `[INSTRUKSI KHUSUS: ${this.customInstruction}]\n\n` + textToSend;
                }

                try {
                    const response = await fetch('/paraphrase', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: textToSend,
                            style: this.selectedStyle,
                            model: this.selectedModel
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        this.outputText = data.paraphrased_text;
                        // Auto scroll to top of result
                        this.$nextTick(() => {
                             document.querySelector('.focus-card.has-result .custom-scroll')?.scrollTo(0,0);
                        });
                    } else {
                        alert("Error: " + (data.error || "Gagal memproses."));
                    }
                } catch (e) {
                    alert("Terjadi kesalahan koneksi.");
                    console.error(e);
                } finally {
                    this.isLoading = false;
                    this.$nextTick(() => lucide.createIcons());
                }
            },

            renderMarkdown(text) { return this.converter.makeHtml(text); },

            copyResult() {
                const plainText = document.getElementById('output-content').innerText;
                navigator.clipboard.writeText(plainText).then(() => alert("Teks berhasil disalin!"));
            },

            exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const elementHTML = document.getElementById('output-content');
                
                doc.html(elementHTML, {
                    callback: function(doc) { doc.save('OnThesis-Paraphrase.pdf'); },
                    x: 15, y: 15, width: 180, windowWidth: 800
                });
            },
            
            exportDoc() {
                const html = document.getElementById('output-content').innerHTML;
                const blob = htmlDocx.asBlob(html, { orientation: 'portrait', margins: { top: 720 } });
                saveAs(blob, 'OnThesis-Paraphrase.docx');
            }
        }
    }
</script>
{% endblock %}