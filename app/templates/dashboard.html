{% extends "base.html" %}

{% block title %}Command Center - OnThesis{% endblock %}

{% block page_styles %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    .glass-card {
        background: linear-gradient(145deg, rgba(30, 32, 38, 0.6) 0%, rgba(18, 20, 23, 0.8) 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 1.5rem; /* 24px */
        transition: transform 0.2s, border-color 0.2s;
    }
    .glass-card:hover {
        border-color: rgba(108, 93, 211, 0.3);
        transform: translateY(-2px);
    }
    
    .skeleton {
        background: rgba(255,255,255,0.05);
        animation: pulse 1.5s infinite;
        border-radius: 0.5rem;
    }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
</style>
{% endblock %}

{% block content %}
<div x-data="dashboardApp" 
     x-cloak 
     @firebase-ready.window="initFirebase($event.detail)">
    
    <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span class="text-xs font-medium text-text-muted" x-text="currentDate"></span>
            </div>
            <h1 class="text-3xl md:text-4xl font-extrabold text-white tracking-tight">
                Halo, <span class="text-transparent bg-clip-text bg-gradient-to-r from-accent-primary to-accent-cyan">{{ current_user.username }}</span>!
            </h1>
            <p class="text-text-secondary mt-2 text-sm md:text-base max-w-xl leading-relaxed" x-text="quote"></p>
        </div>
        
        <div class="shrink-0">
            <a href="{{ url_for('main.projects') }}" class="btn-primary px-6 py-3 text-sm shadow-lg shadow-accent-primary/20 flex items-center gap-2 group">
                <i data-lucide="plus-circle" class="w-4 h-4 group-hover:rotate-90 transition-transform"></i> 
                <span>Proyek Baru</span>
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="glass-card p-6 group">
            <div class="flex justify-between items-start mb-4">
                <div class="p-3 bg-accent-primary/10 rounded-xl text-accent-primary"><i data-lucide="folder-kanban" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-bold text-text-muted uppercase tracking-wider">Aktif</span>
            </div>
            <div class="min-h-[3rem]">
                <template x-if="loading"><div class="h-8 w-16 skeleton"></div></template>
                <template x-if="!loading"><h3 class="text-4xl font-black text-white" x-text="stats.projects">0</h3></template>
            </div>
            <p class="text-xs text-text-secondary mt-1">Proyek Riset</p>
        </div>

        <div class="glass-card p-6 group">
            <div class="flex justify-between items-start mb-4">
                <div class="p-3 bg-accent-cyan/10 rounded-xl text-accent-cyan"><i data-lucide="book-open" class="w-6 h-6"></i></div>
                <span class="text-[10px] font-bold text-text-muted uppercase tracking-wider">Total</span>
            </div>
            <div class="min-h-[3rem]">
                <template x-if="loading"><div class="h-8 w-16 skeleton"></div></template>
                <template x-if="!loading"><h3 class="text-4xl font-black text-white" x-text="stats.references">0</h3></template>
            </div>
            <p class="text-xs text-text-secondary mt-1">Referensi</p>
        </div>

        <a href="{{ url_for('main.upgrade_page') }}" class="glass-card p-6 group hover:border-accent-primary/50 cursor-pointer">
            <div class="flex justify-between items-start mb-4">
                <div class="p-3 rounded-xl" :class="stats.isPro ? 'bg-green-500/10 text-green-400' : 'bg-yellow-500/10 text-yellow-400'">
                    <i :data-lucide="stats.isPro ? 'zap' : 'lock'" class="w-6 h-6"></i>
                </div>
                <span class="text-[10px] font-bold uppercase tracking-wider px-2 py-1 rounded-lg" 
                      :class="stats.isPro ? 'bg-green-500/10 text-green-400' : 'bg-yellow-500/10 text-yellow-400'"
                      x-text="stats.isPro ? 'PRO PLAN' : 'FREE TIER'">
                </span>
            </div>
            <div class="min-h-[3rem]">
                <template x-if="loading"><div class="h-8 w-24 skeleton"></div></template>
                <template x-if="!loading">
                    <h3 class="text-xl font-bold text-white leading-tight" x-text="stats.isPro ? 'Unlimited Access' : 'Upgrade Sekarang'"></h3>
                </template>
            </div>
            <p class="text-xs text-text-secondary mt-1 flex items-center gap-1 group-hover:text-white transition-colors">Lihat Detail <i data-lucide="arrow-right" class="w-3 h-3"></i></p>
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-8 flex flex-col gap-6">
            
            <div class="glass-card p-6 relative overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-white text-lg flex items-center gap-2">
                        <i data-lucide="activity" class="w-5 h-5 text-accent-primary"></i> Aktivitas Riset
                    </h3>
                    <div class="bg-white/5 border border-white/10 px-3 py-1 rounded-lg">
                        <span class="text-[10px] text-text-secondary font-medium">7 Hari Terakhir</span>
                    </div>
                </div>
                <div id="activityChart" class="-ml-2 min-h-[280px]"></div>
                <template x-if="loading">
                    <div class="absolute inset-0 flex items-center justify-center bg-bg-card/80 z-10"><i data-lucide="loader-2" class="w-8 h-8 animate-spin text-accent-primary"></i></div>
                </template>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-white text-lg">Proyek Terakhir</h3>
                    <a href="{{ url_for('main.projects') }}" class="text-xs font-bold text-accent-primary hover:text-white transition-colors">Lihat Semua</a>
                </div>
                
                <div class="space-y-3">
                    <template x-if="loading">
                        <div class="space-y-3"><div class="h-16 skeleton w-full"></div><div class="h-16 skeleton w-full"></div></div>
                    </template>

                    <template x-if="!loading && projects.length === 0">
                        <div class="text-center py-8 border border-dashed border-white/10 rounded-xl"><p class="text-text-muted text-sm">Belum ada proyek aktif.</p></div>
                    </template>

                    <template x-for="project in projects" :key="project.id">
                        <a href="{{ url_for('main.projects') }}" class="flex items-center gap-4 p-4 rounded-xl bg-bg-input/40 hover:bg-white/5 border border-transparent hover:border-white/10 transition-all group">
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center text-xs font-bold text-white border border-white/5 shrink-0">
                                <span x-text="(project.progress||0) + '%'"></span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-bold text-white truncate group-hover:text-accent-cyan transition-colors" x-text="project.title"></h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="w-1.5 h-1.5 rounded-full" :class="project.status === 'SELESAI' ? 'bg-green-500' : 'bg-yellow-500'"></span>
                                    <span class="text-[10px] text-text-secondary" x-text="project.status || 'DRAFT'"></span>
                                    <span class="text-[10px] text-text-muted">•</span>
                                    <span class="text-[10px] text-text-muted" x-text="formatDate(project.lastUpdated)"></span>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-text-muted group-hover:text-white transition-transform group-hover:translate-x-1"></i>
                        </a>
                    </template>
                </div>
            </div>
        </div>

        <div class="lg:col-span-4 flex flex-col gap-6">
            
            <div class="glass-card p-6 bg-gradient-to-b from-bg-card to-[#1A1D24]">
                <h3 class="font-bold text-white text-lg mb-4">Akses Cepat</h3>
                <div class="grid grid-cols-2 gap-3">
                    <a href="{{ url_for('assistant.writing_assistant') }}" class="p-4 rounded-2xl bg-accent-primary/10 border border-accent-primary/20 hover:bg-accent-primary hover:border-accent-primary group transition-all text-center flex flex-col items-center gap-2">
                        <i data-lucide="pen-tool" class="w-6 h-6 text-accent-primary group-hover:text-white transition-colors"></i>
                        <span class="text-xs font-bold text-white">Writing</span>
                    </a>
                    <a href="{{ url_for('analysis.data_analysis') }}" class="p-4 rounded-2xl bg-accent-cyan/10 border border-accent-cyan/20 hover:bg-accent-cyan hover:border-accent-cyan group transition-all text-center flex flex-col items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-6 h-6 text-accent-cyan group-hover:text-white transition-colors"></i>
                        <span class="text-xs font-bold text-white">Analisis</span>
                    </a>
                    <a href="{{ url_for('main.citation_management') }}" class="p-4 rounded-2xl bg-pink-500/10 border border-pink-500/20 hover:bg-pink-500 hover:border-pink-500 group transition-all text-center flex flex-col items-center gap-2 col-span-2">
                        <i data-lucide="search" class="w-6 h-6 text-pink-500 group-hover:text-white transition-colors"></i>
                        <span class="text-xs font-bold text-white">Cari Jurnal</span>
                    </a>
                </div>
            </div>

            <div class="glass-card p-6 bg-gradient-to-br from-yellow-500/5 to-transparent border-yellow-500/20 relative overflow-hidden">
                <i data-lucide="lightbulb" class="absolute -right-4 -top-4 w-24 h-24 text-yellow-500/5 rotate-12"></i>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-yellow-500/20 text-yellow-400 text-[9px] font-bold px-2 py-0.5 rounded border border-yellow-500/30">PRO TIP</span>
                    </div>
                    <h4 class="text-sm font-bold text-white mb-1">Writer's Block?</h4>
                    <p class="text-xs text-text-secondary leading-relaxed mb-3">Gunakan fitur "Chat AI" di Writing Studio untuk brainstorming ide atau membuat outline bab.</p>
                    <a href="{{ url_for('main.chat_ai') }}" class="text-xs font-bold text-yellow-500 hover:text-yellow-300 transition-colors flex items-center gap-1">
                        Coba Sekarang <i data-lucide="arrow-right" class="w-3 h-3"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block page_scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('dashboardApp', () => ({
            loading: true,
            stats: { projects: 0, references: 0, isPro: false },
            projects: [],
            quote: '',
            currentDate: '',

            init() {
                // Setup Date & Quote
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                this.currentDate = new Date().toLocaleDateString('id-ID', options);
                const quotes = [
                    "“Riset adalah melihat apa yang dilihat orang lain, dan memikirkan apa yang tidak dipikirkan orang lain.”",
                    "“Skripsi yang baik adalah skripsi yang selesai.”",
                    "“Jangan takut salah, takutlah untuk tidak memulai.”",
                    "“Satu halaman hari ini lebih baik daripada nol halaman besok.”"
                ];
                this.quote = quotes[Math.floor(Math.random() * quotes.length)];

                // Initial Fetch
                this.fetchStats();
            },

            async fetchStats() {
                try {
                    const res = await fetch('/api/dashboard-stats');
                    if (res.ok) {
                        const json = await res.json();
                        this.stats.projects = json.stats.projects;
                        this.stats.references = json.stats.references;
                        this.stats.isPro = json.stats.isPro;
                        this.renderChart(json.chart.labels, json.chart.data);
                    }
                } catch (e) {
                    console.error("Stats error:", e);
                    // Fallback chart
                    this.renderChart(['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'], [0, 0, 0, 0, 0, 0, 0]);
                }
            },

            initFirebase(detail) {
                const { db, auth, sdk } = detail;
                auth.onAuthStateChanged(user => {
                    if (user) {
                        this.setupListeners(user.uid, db, sdk);
                    } else {
                        window.location.href = '/login';
                    }
                });
            },

            setupListeners(uid, db, sdk) {
                const { collection, query, where, onSnapshot, orderBy, limit } = sdk;
                
                // Realtime Projects List
                const qProjects = query(collection(db, "projects"), where("userId", "==", uid), orderBy("lastUpdated", "desc"), limit(3));
                
                try {
                    onSnapshot(qProjects, (snap) => {
                        this.projects = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        this.loading = false;
                        this.$nextTick(() => lucide.createIcons());
                    }, (err) => {
                        // Fallback if index missing
                        const qFallback = query(collection(db, "projects"), where("userId", "==", uid), limit(3));
                        onSnapshot(qFallback, (snap) => {
                            this.projects = snap.docs.map(d => ({id: d.id, ...d.data()}));
                            this.loading = false;
                            this.$nextTick(() => lucide.createIcons());
                        });
                    });
                } catch(e) { this.loading = false; }
            },

            renderChart(labels, data) {
                const options = {
                    series: [{ name: 'Aktivitas', data: data }],
                    chart: { 
                        type: 'area', 
                        height: 280, 
                        toolbar: { show: false }, 
                        background: 'transparent', 
                        fontFamily: 'Plus Jakarta Sans, sans-serif' 
                    },
                    colors: ['#6C5DD3'],
                    fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 100] } },
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 3 },
                    xaxis: { 
                        categories: labels,
                        labels: { style: { colors: '#64748B', fontSize: '11px' } },
                        axisBorder: { show: false }, axisTicks: { show: false },
                        tooltip: { enabled: false }
                    },
                    yaxis: { 
                        labels: { style: { colors: '#64748B', fontSize: '11px' }, formatter: (val) => val.toFixed(0) } 
                    },
                    grid: { borderColor: 'rgba(255,255,255,0.05)', strokeDashArray: 4 },
                    tooltip: { theme: 'dark' },
                    theme: { mode: 'dark' }
                };
                const container = document.querySelector("#activityChart");
                container.innerHTML = ''; 
                const chart = new ApexCharts(container, options);
                chart.render();
            },

            formatDate(ts) {
                if (!ts) return '-';
                const date = ts.toDate ? ts.toDate() : new Date(ts);
                return new Intl.DateTimeFormat('id-ID', { day: 'numeric', month: 'short' }).format(date);
            }
        }));
    });
</script>

<script type="module">
    import { db, auth } from "{{ url_for('static', filename='js/firebase.js') }}";
    import * as FirestoreSDK from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const evt = new CustomEvent('firebase-ready', { 
        detail: { db, auth, sdk: FirestoreSDK } 
    });
    window.dispatchEvent(evt);
</script>
{% endblock %}